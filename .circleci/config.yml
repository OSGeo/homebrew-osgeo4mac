version: 2
jobs:
  update-homebrew:
    macos:
      xcode: "10.1.0"
    environment:
      CIRCLE_REPOSITORY_URL: https://github.com/osgeo/homebrew-osgeo4mac
      HOMEBREW_DEVELOPER: 1
      HOMEBREW_NO_AUTO_UPDATE: 1
    steps:
      - checkout

      - restore_cache:
          keys:
            - homebrew-v1-{{ .Branch }}-{{ .Revision }}
            - homebrew-v1-{{ .Branch }}-
            - homebrew-v1-

      - run:
          name: Update environment variables
          command: .circleci/set_env.sh

      - run:
          name: Before install script
          command: .circleci/before_install.sh

      - run:
          name: Install dependencies
          command: .circleci/install.sh

      - run:
           name: Install changed formulae
           command: .circleci/script.sh

      - run:
           name: Build bottles
           # no_output_timeout: 30m
           command: .circleci/after_script.sh

      # - run:
      #     name: Create release
      #     command: |
      #       git fetch --tags
      #       curl -O https://raw.githubusercontent.com/reactiveops/release.sh/v0.0.2/release
      #       /bin/bash release

      - persist_to_workspace:
          root: /tmp
          paths:
            - bottles

  create-macos-pr:
    macos:
      xcode: "10.1.0"
    environment:
      CIRCLE_REPOSITORY_URL: https://github.com/osgeo/homebrew-osgeo4mac
      HOMEBREW_DEVELOPER: 1
      HOMEBREW_NO_AUTO_UPDATE: 1
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - checkout
      - run: |
          git config --global user.name "Geo Ninja"
          git config --global user.email "qgisninja@gmail.com"
      - run: |
          brew install hub
          TAP_PATH=$(brew --repo $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME)
          mkdir -p $TAP_PATH
          cp -a ./ $TAP_PATH/
          brew tap --repair
          # create pull request
          cd $TAP_PATH
          git reset --hard origin/$CIRCLE_BRANCH
          brew bottle --merge --write /tmp/workspace/bottles/*.json
          RELEASE_TAG=$(echo "$CIRCLE_BRANCH" | sed -nE 's/(^[@a-z0-9\.\-]+-[0-9\._]+)#(macos-)?bottle$/\1/p')
          git checkout -b "$RELEASE_TAG#pr"
          git remote set-url origin https://$CIRCLE_PROJECT_USERNAME:$GITHUB_TOKEN@github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
          git push --set-upstream --force origin "$RELEASE_TAG#pr"
          hub pull-request -m "$(git log -1 --pretty=%B)"

  create-pr:
    docker:
      - image: linuxbrew/brew
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - checkout
      - run: |
          git config --global user.name "Geo Ninja"
          git config --global user.email "qgisninja@gmail.com"
      - run: |
          brew install hub
          TAP_PATH=$(brew --repo $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME)
          mkdir -p $TAP_PATH
          cp -a ./ $TAP_PATH/
          brew tap --repair
          # create pull request
          cd $TAP_PATH
          git reset --hard origin/$CIRCLE_BRANCH
          brew bottle --merge --write /tmp/workspace/bottles/*.json
          RELEASE_TAG=$(echo "$CIRCLE_BRANCH" | sed -nE 's/(^[@a-z0-9\.\-]+-[0-9\._]+)#(macos-)?bottle$/\1/p')
          git checkout -b "$RELEASE_TAG#pr"
          git remote set-url origin https://$CIRCLE_PROJECT_USERNAME:$GITHUB_TOKEN@github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
          git push --set-upstream --force origin "$RELEASE_TAG#pr"
          hub pull-request -m "$(git log -1 --pretty=%B)"


workflows:
  version: 2
  build:
    jobs:
      - update-homebrew
      - create-macos-pr:
          requires:
            - update-homebrew
          filters:
            branches:
              only: /.*#macos-bottle/
      - create-pr:
          requires:
            - update-homebrew
          filters:
            branches:
              only: /.*#bottle/
      - bottle-macos:
          filters:
            branches:
              only: /.*#bottle|.*#macos-bottle/
