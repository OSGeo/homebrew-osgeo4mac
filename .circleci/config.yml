build_steps: &build_steps
  steps:
    - checkout
    - run:
       name: Update environment variables
       command: .circleci/set_env.sh
    - run:
       name: Git config
       command: |
         git remote set-url origin $CIRCLE_REPOSITORY_URL
         git fetch origin
         git config --global user.name "geo-ninja"
         git config --global user.email "qgisninja@gmail.com"
    - run:
       name: Before install script
       command: .circleci/before_install.sh
    - run:
       name: Install dependencies
       command: .circleci/install.sh
    - run:
        name: Install changed formulae
        command: .circleci/script.sh
    # # fix for ERROR: The key you are authenticating with has been marked as read only.
    # # is using the first key that is found, the one assigned in Checkout keys
    # # not Add deploy key
    # # https://circleci.com/gh/OSGeo/homebrew-osgeo4mac/edit#checkout
    # # Add deployment key fingerprint for CircleCI to use for a push
    # - add_ssh_keys:
    #     fingerprints:
    #       - "${KEY_FINGERPRINT}"
    # - run:
    #     name: Avoid hosts unknown for github
    #     command: |
    #       echo -e "Host github.com\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
    - run:
        name: Build bottles
        no_output_timeout: 30m
        command: .circleci/after_script.sh
    - run:
        name: Fix for Persist Workspace
        command: |
          echo "fix" > /tmp/bottles/fix.txt
    - checkout
    - persist_to_workspace:
        root: /tmp
        paths:
          - bottles/*
    - run:
        name: Fix for Attaching Workspace
        command: |
          rm /tmp/bottles/fix.txt
    - store_test_results:
        path: /tmp/bottles
    # - attach_workspace:
    #     at: /tmp/workspace
    # - store_artifacts:
    #     path: /tmp/workspace/bottles
    #     destination: bottles

workflow_filter: &filter
  filters:
    branches:
      only:
        - master

version: 2
jobs:
  update-homebrew:
    macos:
      xcode: "10.1.0"

    steps:
      - restore_cache:
          keys:
            - homebrew-v1-{{ .Branch }}-{{ .Revision }}
            - homebrew-v1-{{ .Branch }}-
            - homebrew-v1-
      - run:
          name: "Update homebrew"
          command: |
            brew tap brewsci/bio || true
            brew tap brewsci/science || true
            brew untap brewsci/science || true
            brew update || brew update
      - save_cache:
          key: homebrew-v1-{{ .Branch }}-{{ .Revision }}
          paths:
            - /usr/local/Homebrew/Library/Taps/homebrew
            - /usr/local/Homebrew/Library/Taps/brewsci

  sierra-build:
    <<: *build_steps
    <<: *filter
    macos:
      xcode: "8.3.3"

  high_sierra-build:
    <<: *build_steps
    <<: *filter
    macos:
      xcode: "10.1.0"

  collect-bottles:
    macos:
      xcode: "10.1.0"
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - checkout
      - run:
         name: Update environment variables
         command: .circleci/set_env.sh
      - run: |
          git config --global user.name "geo-ninja"
          git config --global user.email "qgisninja@gmail.com"
      # fix for ERROR: The key you are authenticating with has been marked as read only.
      # is using the first key that is found, the one assigned in Checkout keys
      # not Add deploy key
      # Add deployment key fingerprint for CircleCI to use for a push
      - add_ssh_keys:
          fingerprints:
            - "${KEY_FINGERPRINT}"
      - run:
          name: Avoid hosts unknown for github
          command: |
            echo -e "Host github.com\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
      - run:
          name: Commit for new bottles and upload to bintray
          command: |
            ls
            ls /tmp
            .circleci/before_deploy.sh
            if [ "$CIRCLE_BRANCH" != "master" ] && [ "$CHANGED_FORMULAE" != "" ]; then
            # This hook will add [ci skip] the the commit messages for bottle DSL
            # so that ci does not re-build a duplicate bottle on pushing.
            # touch .git/hooks/commit-msg
            cp -r ./commit-msg.sh .git/hooks/commit-msg
            cat .git/hooks/commit-msg
            # echo 'echo "\n\n[ci skip]" >> "$1"' >> .git/hooks/commit-msg; chmod +x .git/hooks/commit-msg
            # This hook will add [ci skip] the the commit messages for bottle DSL
            # so that circle-ci does not re-build a duplicate bottle on pushing.
            fi
      # - store_artifacts:
      #     path: /tmp/workspace/bottles
      #     destination: bottles

  deploy:
    macos:
      xcode: "10.1.0"
    steps:
      - checkout
      - run: brew install jfrog-cli-go
      - run: jfrog bt config --user=${BINTRAY_USER} --key=${BINTRAY_API} --licenses=MIT
      - run: echo "jfrog" > /tmp/workspace/bottles/jfrog.txt
      - run: jfrog bt upload --publish=true "/tmp/workspace/bottles/jfrog.txt" homebrew-osgeo/osgeo-bottles/bottles/0.1/
      # - run: jfrog bt upload --publish=true "/tmp/workspace/bottles/*" homebrew-osgeo/osgeo-bottles/bottles/0.1/
      - store_artifacts:
          path: /tmp/workspace/bottles
          destination: bottles

workflows:
  version: 2
  test-bot:
    jobs:
      - update-homebrew
      - high_sierra-build:
          requires:
            - update-homebrew
      - sierra-build:
          requires:
            - update-homebrew
      - collect-bottles:
          requires:
            - high_sierra-build
            - sierra-build
      - deploy:
          requires:
            - collect-bottles
          filters:
            branches:
              only: master
