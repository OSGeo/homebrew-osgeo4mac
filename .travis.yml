language: ruby
rvm:
  - 2.3.7
# language: python
# python:
#  - "2.7"
os: osx
env: OSX=10.12
osx_image: xcode8.3
sudo: required

branches:
  except:
    - circleci

# (1) remember to use 'brew cleanup -s' at the end of the travis script;
# otherwise, the $HOME/Library/Caches/Homebrew folder will be enormous
# (~2GB for the 4 jobs). This is because this folder is already present on
# osx images and it is big.
# (2) For a time, I had removed $HOME/.cache/Homebrew (cache of Linuxbrew)
# because it was also storing some logs in $HOME/.cache/Homebrew/Logs, making
# the cache rebuilt every time.
# /usr/local subdirs are Homebrew components
cache:
  directories:
    - "$HOME/.cache/pip"
    - "$HOME/.gem/ruby"
    - "$HOME/Library/Caches/Homebrew" # (1)
    - "$HOME/.cache/Homebrew" # (2)
    - $HOME/Library/Caches/pip
#     - /usr/local/Cellar
#     - /usr/local/Frameworks
#     - /usr/local/Homebrew
#     - /usr/local/bin
#     - /usr/local/etc
#     - /usr/local/include
#     - /usr/local/lib
#     - /usr/local/opt
#     - /usr/local/share
#     - /usr/local/var
#   timeout: 900
# before_cache:
#  - ./travis/before_cache.sh

addons:
  ssh_known_hosts: github.com

before_install:
  - gem update --system
  - gem install bundler
  - export GH_USER=$(echo -n "${TRAVIS_REPO_SLUG}" | egrep -o '^[^/]+' | tr -d '\n')
  - export TRAVIS_COMMIT="$(git rev-parse --verify -q HEAD)"
  - export CHANGED_FORMULAE=$(./travis/changed_formulas.sh)
  - if [ "${CHANGED_FORMULAE}" == "" ]; then
      echo "Skipping CI; no changed formulae found in $TRAVIS_BUILD_DIR";
      exit 0 || true;
      travis_terminate 0;
      exit 1;
    else
      echo "Changed formulae are ${CHANGED_FORMULAE}";
    fi
  - if [ "${CHANGED_FORMULAE}" == "osgeo-qt-webkit" ] || [ "${CHANGED_FORMULAE}" == "osgeo-qgis" ] || [ "${CHANGED_FORMULAE}" == "osgeo-qgis-ltr" ]|| [ "${CHANGED_FORMULAE}" == "osgeo-vtk" ]|| [ "${CHANGED_FORMULAE}" == "osgeo-insighttoolkit" ]; then
      echo "Skipping CI; These formulas exceed the time limit in Travis CI.";
      exit 0 || true;
      travis_terminate 0;
      exit 1;
    fi
  - export HOMEBREW_REPOSITORY="$(brew --repo)"
  - sudo chown -R "$USER":admin "${HOMEBREW_REPOSITORY}"
  - brew --version
  - brew remove $(brew list)
  - rm -rf /usr/local/Homebrew/Library/Taps/
  - brew update-reset
  - brew --env
  - brew config
  - TRAVIS_REPOSITORY_URL=https://github.com/OSGeo/homebrew-osgeo4mac
  - cd "${HOMEBREW_REPOSITORY}/Library/Taps/${TRAVIS_REPO_SLUG}"
  - git remote set-url origin $TRAVIS_REPOSITORY_URL
  - git fetch origin
  - git config --global user.name "geo-ninja"
  - git config --global user.email "qgisninja@gmail.com"
  # - git -C "${HOMEBREW_REPOSITORY}" reset --hard origin/master
  # IMPORTANT STEP: link the tap inside brew to our current travis-cloned tap
  # Step: 1) create the intermediate folders <user>/<repo> so that
  # we can 2) remove <repo> and 3) replace it with a sym link
  # that will point to the travis build folder.
  # If we don't do that, the tap be cloned using the default master
  # branch, and thus we cannot test our tap at the current pushed commit.
  # We also need to unshallow in 4) because sometimes travis does not
  # clone thouroughly but we need a deep clone.
  # - mkdir -p $(brew --repo $TRAVIS_REPO_SLUG) # 1)
  # - mkdir -p "${HOMEBREW_REPOSITORY}/Library/Taps/${GH_USER}"
  - repo=$(brew --repo $TRAVIS_REPO_SLUG)
  - mkdir -p $repo
  - cp -a ./ $repo/
  # - rm -rf $(brew --repo $TRAVIS_REPO_SLUG)     # 2)
  # - ln -s $PWD $(brew --repo $TRAVIS_REPO_SLUG) # 3)
  # - ln -s "$TRAVIS_BUILD_DIR" "${HOMEBREW_REPOSITORY}/Library/Taps/${TRAVIS_REPO_SLUG}"
  # - git fetch --unshallow || true               # 4)
  - cd "${HOMEBREW_REPOSITORY}/Library/Taps/${TRAVIS_REPO_SLUG}"
  - chmod -f 0644 ${HOMEBREW_REPOSITORY}/Library/Taps/${TRAVIS_REPO_SLUG}/Formula/*.rb
  - export TRAVIS_BUILD_DIR="${HOMEBREW_REPOSITORY}/Library/Taps/${TRAVIS_REPO_SLUG}"
  - export HOMEBREW_DEVELOPER=1
  - export HOMEBREW_NO_AUTO_UPDATE=1
  - export HOMEBREW_PREFIX=$(brew --prefix)
  - ulimit -n 1024

before_install: # IMPORTANT: HOMEBREW_DEVELOPER must not be set here.
  # First we uninstall any outdated versions of xquartz; otherwise,
  # Homebrew will complain of of older version (2.9.7) being outdated
  # even though we install a new version. Remember that
  # /usr/local/Caskroom will also be deleted below.
  # - brew cask outdated xquartz || brew cask uninstall xquartz
  # Three reasons not to use the /usr/local and Homebrew installations
  # that come in the Travis CI images:
  # 1) because Travis CI has installed many non-homebrew things into
  #    /usr/local that randomly cause 'brew doctor' to fail;
  # 2) after time, the osx image contains an outdated Homebrew that
  #    has weird 'unlinked kegs' and such;
  # 3) also because it takes a long time to 'brew update' from an old
  #    Homebrew anyway, so why not start fresh.
  - mkdir ~/usr_local && sudo mv /usr/local/* ~/usr_local
  - /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  - ./travis/before_install.sh

  # Either xquartz was already installed at its latest version or it has
  # been uninstalled. First, we put the cask back in place if it has not
  # been uninstalled.
  # - |
  #   if [ -d ~/usr_local/Caskroom/xquartz ];
  #   then sudo mv ~/usr_local/Caskroom /usr/local/Caskroom;
  #   else travis_retry brew cask install xquartz; fi
  # We still need the Homebrew ruby on macOS 10.12 and 10.11 because the
  # system ruby uses an old openssl version ("tlsv1 alert protocol").
  - travis_retry brew install libyaml gmp openssl@1.1 openssl

install: ./travis/install.sh

before_script: ./travis/before_script.sh

script: ./travis/script.sh

after_script: ./travis/after_script.sh

before_cache:
  # Scrub cache so that travis only caches stuff for installed formulae.
  - brew cleanup -s
  # - brew cask cleanup
  # Remove temporary stuff (idk why they put that in ~/.cache... that should be in /tmp)
  - rm -f ~/Library/Caches/Homebrew/linkage.db ~/.cache/Homebrew/linkage.db
  # List the formulae so that I understand why the cache is huge sometimes
  - brew list
  - du -h ~/Library/Caches/Homebrew || du -h ~/.cache/Homebrew/linkage.db

before_deploy:
  # Get the deploy key by using Travis's stored variables to decrypt deploy_key.enc
  # Decrypt the travis_deploy_key.enc key into /tmp/travis_deploy_key
  - openssl aes-256-cbc -K $encrypted_key -iv $encrypted_iv -in travis_deploy_key.enc -out /tmp/travis_deploy_key -d
  # Make sure only the current user can read the private key
  - chmod 600 /tmp/travis_deploy_key
  # Create a script to return the passphrase environment variable to ssh-add
  - echo 'echo ${SSH_PASSPHRASE}' > /tmp/askpass && chmod +x /tmp/askpass
  # Start the authentication agent
  - eval "$(ssh-agent -s)"
  # Add the key to the authentication agent
  - brew install util-linux # for setsid
  - DISPLAY=":0.0" SSH_ASKPASS="/tmp/askpass" setsid ssh-add /tmp/travis_deploy_key </dev/null
  # add changes
  - ./travis/before_deploy.sh

# is disabled to use Circle CI

# deploy:
#   skip_cleanup: true
#   provider: bintray
#   file: travis/bintray-upload.json
#   user: nickrobison
#   key:
#     secure: "nEmP/uU8N+TbbX3zWED62CsjPxoDjXcOF3RtAENW/4qVBdI9r7dFmyE4WAW732Ttd1PbANPz7Lz494j2TS2hbn2R4yQ9CuIllsnjey/ve6TAq1FfYSruBuMGLK/7EJ/cSfZWsOBex7b68UeVlvyAra3ck6y9j1ouzF9RKEtCx3P/w3heLN5Fl0pNUCzwknrdBFGfTQRy8NSQnYo/8mpIQbCrXEQThJ4PZY/7s5tqDOv3tAesPTdoGmoNWWBoQe8ZnrwSutskcm6Nsf5nz64i44vai9Xx+9U3QpHDvzuAXOzwxFBGk1dfsnLRp/P71QrDYuqnMEExmfdZAWYK0o0JLuwsecOfSvG2C14fAp1rA2GNWMK9SViYxeYnJgwenGgd7FBci6N052mvyv3+52xGc7aHUlp74PvqYEv8LoILdOlG9jGj1jS41seQyW7Qyg6VYfQ+f1Vp4kUupH3EE53QgJzM6rVyFI9qmkThJTN0ZhUzIhwrTqUfceMkWyeYKd7/hk6AUxhYNZehtR7xH8pf1vibLifUr978M4vyutSwJ4xnaJKTvuUdA0d2GQHAuEDwfqPlYcIUDbKOVmbKj+SifKdSlcwGTYunzmKkJskA9DzYIbUjKe00jluAvjGZuoCIbIKdqlH1ntTUoW5OCpE09TmIZdh/SURRKo7QsfLNQ0I="
#   # S3 bucket upload, which is not working right now
#   # provider: s3
#   # access_key_id:
#   #   secure: JxG4/zxgbYvKqX4kJTZdQxvAL+EHqmmi4OEjAOY+KUFAP4t9l5aLEYh6brjHF07kDyFyjMt8G7Hf+SZeznA/JGe8NaliXfCnxLH7ftApCP3l/Tl73z3wXnGL1L7EljiO0EbwlsJUM23B+01BMalzBfyLYOEc61LfSuJsEFFa/ck=
#   # secret_access_key:
#   #   secure: ZdsR1FsY6ER6w6KvF9rjxY4s7GjLXRkT9Rmv4GWyL9+pcHI/4/2KMfab6gj1sQdbc2ocfBgGXR8hQZHi+NZPyTnHbIXf5n2YenLo9NyOHwNs1qiJgxXgtYvhtI/NXCcD9JgX5i5BRR3jkPqJBRe70CmoTwv29kR5Tp158tr3gIg=
#   # bucket: osgeo4mac
#   # local-dir: bottles
#   # upload-dir: bottles
#   # acl: public_read
#   on:
#     branch: master
#     repo: OSGeo/homebrew-osgeo4mac
